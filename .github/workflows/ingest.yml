name: Ingest Space

on:
  push:
    paths:
      - 'space_queue.txt'
  workflow_dispatch:
    inputs:
      space_url:
        description: 'Twitter Space URL (Optional overrides queue file)'
        required: false
        type: string

# Prevent race conditions during RSS deployment
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest
    outputs:
      mp3_path: ${{ steps.process.outputs.mp3_path }}
      release_tag: ${{ steps.process.outputs.release_tag }}
      space_title: ${{ steps.process.outputs.space_title }}
      duration: ${{ steps.duration.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install yt-dlp
        run: python3 -m pip install -r requirements.txt

      - name: Run Ingest Script
        id: process
        env:
          MANUAL_URL: ${{ inputs.space_url }}
        run: ./scripts/ingest.sh

      - name: Extract MP3 Duration
        id: duration
        if: success()
        run: |
          DURATION=$(ffprobe -v error -show_entries format=duration \
            -of default=noprint_wrappers=1:nokey=1 "${{ steps.process.outputs.mp3_path }}" \
            | awk '{printf "%02d:%02d:%02d", ($1/3600), ($1%3600/60), ($1%60)}')
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
      
      - name: Clear Queue File
        if: success() && inputs.space_url == ''
        run: |
          echo "" > space_queue.txt
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "chore: clear processed space from queue" || echo "No changes to commit"
          git push

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: ${{ steps.process.outputs.release_tag }}
          name: "${{ steps.process.outputs.space_title }}"
          files: ${{ steps.process.outputs.mp3_path }}
          body: |
            **Space Title:** ${{ steps.process.outputs.space_title }}
            **Duration:** ${{ steps.duration.outputs.duration }}
            **Processed:** ${{ steps.process.outputs.release_tag }}
            
            ---
            METADATA::DURATION::${{ steps.duration.outputs.duration }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  rss:
    needs: ingest
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Generate RSS Feed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PODCAST_TITLE: "My Spaces Archive"
          PODCAST_DESC: "An automated archive of Twitter Spaces."
          PODCAST_AUTHOR: "Logan Black"
          PODCAST_EMAIL: "loganblack0@gmail.com"
          PODCAST_IMAGE: "https://picsum.photos/1400/1400"
          BASE_URL: "https://github.com/${{ github.repository }}/releases/download"
        run: |
          cat <<'EOF' > generate_rss.py
          import os
          import json
          import re
          import urllib.request
          from datetime import datetime
          from xml.sax.saxutils import escape

          # Configuration
          repo = os.environ['REPO']
          token = os.environ['GH_TOKEN']
          title = os.environ.get('PODCAST_TITLE', 'Twitter Spaces Archive')
          desc = os.environ.get('PODCAST_DESC', 'Archive of Twitter Spaces')
          author = os.environ.get('PODCAST_AUTHOR', 'Logan Black')
          email = os.environ.get('PODCAST_EMAIL', 'loganblack0@gmail.com')
          image_fallback = os.environ.get('PODCAST_IMAGE', 'https://picsum.photos/1400/1400')
          
          github_pages_url = f"https://{repo.split('/')[0]}.github.io/{repo.split('/')[1]}/"
          rss_url = f"{github_pages_url}podcast.xml"

          # Artwork Logic: Use local artwork.jpg if exists, else fallback
          if os.path.exists('artwork.jpg'):
              image = f"{github_pages_url}artwork.jpg"
          else:
              image = image_fallback

          print(f"Fetching releases for {repo}...")

          req = urllib.request.Request(f"https://api.github.com/repos/{repo}/releases")
          req.add_header('Authorization', f'token {token}')
          req.add_header('Accept', 'application/vnd.github.v3+json')

          try:
              with urllib.request.urlopen(req) as response:
                  releases = json.loads(response.read())
          except Exception as e:
              print(f"Failed to fetch releases: {e}")
              exit(1)

          rss_items = []
          latest_pub_date = None

          for release in releases:
              if release.get('draft') or release.get('prerelease'):
                  continue
              
              pub_date_str = release.get('published_at') # ISO 8601
              dt = datetime.strptime(pub_date_str, "%Y-%m-%dT%H:%M:%SZ")
              rfc822_date = dt.strftime("%a, %d %b %Y %H:%M:%S GMT")
              
              if latest_pub_date is None or dt > latest_pub_date:
                  latest_pub_date = dt

              # Extract duration from body metadata
              body = release.get('body', '')
              duration_match = re.search(r'METADATA::DURATION::(\d{2}:\d{2}:\d{2})', body)
              duration = duration_match.group(1) if duration_match else "00:00:00"

              for asset in release.get('assets', []):
                  if asset['name'].endswith('.mp3'):
                      file_url = asset['browser_download_url']
                      file_size = asset['size']
                      guid = str(asset['id'])
                      item_title = escape(release.get('name', 'Untitled Space'))
                      
                      rss_items.append(f"""
              <item>
                <title>{item_title}</title>
                <description>{item_title} - Twitter Space Replay</description>
                <pubDate>{rfc822_date}</pubDate>
                <enclosure url="{file_url}" length="{file_size}" type="audio/mpeg"/>
                <guid isPermaLink="false">{guid}</guid>
                <itunes:duration>{duration}</itunes:duration>
                <itunes:explicit>no</itunes:explicit>
              </item>""")

          # Last Build Date
          last_build_date = datetime.now().strftime("%a, %d %b %Y %H:%M:%S GMT")

          rss_content = f"""<?xml version="1.0" encoding="UTF-8"?>
          <rss version="2.0" 
               xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd" 
               xmlns:googleplay="http://www.google.com/schemas/play-podcasts/1.0"
               xmlns:podcast="https://podcastindex.org/namespace/1.0"
               xmlns:atom="http://www.w3.org/2005/Atom">
            <channel>
              <title>{escape(title)}</title>
              <link>{github_pages_url}</link>
              <description>{escape(desc)}</description>
              <language>en-us</language>
              <lastBuildDate>{last_build_date}</lastBuildDate>
              <atom:link href="{rss_url}" rel="self" type="application/rss+xml" />
              <itunes:author>{escape(author)}</itunes:author>
              <itunes:owner>
                <itunes:name>{escape(author)}</itunes:name>
                <itunes:email>{escape(email)}</itunes:email>
              </itunes:owner>
              <itunes:image href="{image}"/>
              <image>
                <url>{image}</url>
                <title>{escape(title)}</title>
                <link>{github_pages_url}</link>
              </image>
              <itunes:category text="Technology"/>
              <itunes:explicit>no</itunes:explicit>
              {''.join(rss_items)}
            </channel>
          </rss>
          """

          with open('podcast.xml', 'w') as f:
              f.write(rss_content)
              
          print("Successfully generated podcast.xml")
          EOF
          python3 generate_rss.py

      - name: Validate RSS
        run: |
          if ! grep -q '<rss version="2.0"' podcast.xml; then
            echo "❌ Invalid RSS structure"
            exit 1
          fi
          if ! grep -q 'METADATA::DURATION' podcast.xml && grep -q '00:00:00' podcast.xml; then
             echo "⚠️ Warning: Duration might be default"
          fi
          echo "✅ RSS validation passed"

      - name: Deploy RSS to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc665646396ad65a5885c0094776106369065 # v3.9.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          exclude_assets: '.github,scripts,space_queue.txt,generate_rss.py,README.md'