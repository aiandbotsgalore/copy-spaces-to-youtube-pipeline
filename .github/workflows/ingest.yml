name: Ingest Space

on:
  push:
    paths:
      - 'space_queue.txt'
  workflow_dispatch:
    inputs:
      space_url:
        description: 'Twitter Space URL (Optional overrides queue file)'
        required: false
        type: string

# Prevent race conditions during RSS deployment
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest
    outputs:
      mp3_path: ${{ steps.process.outputs.mp3_path }}
      release_tag: ${{ steps.process.outputs.release_tag }}
      space_title: ${{ steps.process.outputs.space_title }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install yt-dlp
        run: python3 -m pip install -U yt-dlp

      - name: Run Ingest Script
        id: process
        env:
          MANUAL_URL: ${{ inputs.space_url }}
        run: ./scripts/ingest.sh
      
      - name: Clear Queue File
        if: success() && inputs.space_url == ''
        run: |
          echo "" > space_queue.txt
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "chore: clear processed space from queue" || echo "No changes to commit"
          git push

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: ${{ steps.process.outputs.release_tag }}
          name: "${{ steps.process.outputs.space_title }}"
          files: ${{ steps.process.outputs.mp3_path }}
          body: "Auto-generated release from Twitter Space ingest."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  rss:
    needs: ingest
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Generate RSS Feed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PODCAST_TITLE: "My Spaces Archive"
          PODCAST_DESC: "An automated archive of Twitter Spaces."
          PODCAST_AUTHOR: "Space Host"
          PODCAST_EMAIL: "host@example.com"
          PODCAST_IMAGE: "https://picsum.photos/1400/1400"
          BASE_URL: "https://github.com/${{ github.repository }}/releases/download"
        run: |
          cat <<'EOF' > generate_rss.py
          import os
          import json
          import urllib.request
          from datetime import datetime
          from xml.sax.saxutils import escape

          # Configuration
          repo = os.environ['REPO']
          token = os.environ['GH_TOKEN']
          title = os.environ.get('PODCAST_TITLE', 'Twitter Spaces Archive')
          desc = os.environ.get('PODCAST_DESC', 'Archive of Twitter Spaces')
          author = os.environ.get('PODCAST_AUTHOR', 'Archivist')
          email = os.environ.get('PODCAST_EMAIL', 'archive@example.com')
          image = os.environ.get('PODCAST_IMAGE', 'https://picsum.photos/1400/1400')
          github_pages_url = f"https://{repo.split('/')[0]}.github.io/{repo.split('/')[1]}/"

          print(f"Fetching releases for {repo}...")

          req = urllib.request.Request(f"https://api.github.com/repos/{repo}/releases")
          req.add_header('Authorization', f'token {token}')
          req.add_header('Accept', 'application/vnd.github.v3+json')

          try:
              with urllib.request.urlopen(req) as response:
                  releases = json.loads(response.read())
          except Exception as e:
              print(f"Failed to fetch releases: {e}")
              exit(1)

          rss_items = []

          for release in releases:
              if release.get('draft') or release.get('prerelease'):
                  continue
              
              pub_date = release.get('published_at') # ISO 8601
              # Convert to RFC 822 for RSS (e.g., Wed, 02 Oct 2002 13:00:00 GMT)
              dt = datetime.strptime(pub_date, "%Y-%m-%dT%H:%M:%SZ")
              rfc822_date = dt.strftime("%a, %d %b %Y %H:%M:%S GMT")
              
              for asset in release.get('assets', []):
                  if asset['name'].endswith('.mp3'):
                      file_url = asset['browser_download_url']
                      file_size = asset['size']
                      guid = str(asset['id'])
                      item_title = escape(release.get('name', 'Untitled Space'))
                      
                      rss_items.append(f"""
              <item>
                <title>{item_title}</title>
                <description>{item_title} - Twitter Space Replay</description>
                <pubDate>{rfc822_date}</pubDate>
                <enclosure url="{file_url}" length="{file_size}" type="audio/mpeg"/>
                <guid isPermaLink="false">{guid}</guid>
                <itunes:duration>0</itunes:duration>
                <itunes:explicit>no</itunes:explicit>
              </item>""")

          rss_content = f"""<?xml version="1.0" encoding="UTF-8"?>
          <rss version="2.0" 
               xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd" 
               xmlns:googleplay="http://www.google.com/schemas/play-podcasts/1.0">
            <channel>
              <title>{escape(title)}</title>
              <link>{github_pages_url}</link>
              <description>{escape(desc)}</description>
              <language>en-us</language>
              <itunes:author>{escape(author)}</itunes:author>
              <itunes:owner>
                <itunes:name>{escape(author)}</itunes:name>
                <itunes:email>{escape(email)}</itunes:email>
              </itunes:owner>
              <itunes:image href="{image}"/>
              <itunes:category text="Technology"/>
              <itunes:explicit>no</itunes:explicit>
              {''.join(rss_items)}
            </channel>
          </rss>
          """

          with open('podcast.xml', 'w') as f:
              f.write(rss_content)
              
          print("Successfully generated podcast.xml")
          EOF
          python3 generate_rss.py