name: Update RSS Feed

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: rss-update
  cancel-in-progress: true

jobs:
  rss:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate RSS Feed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          cat <<'PYEOF' > gen_rss.py
          import os, json, re, urllib.request
          from datetime import datetime
          from xml.sax.saxutils import escape

          repo = os.environ['REPO']
          token = os.environ['GH_TOKEN']

          pages_url = f"https://{repo.split('/')[0]}.github.io/{repo.split('/')[1]}/"

          # Artwork - use local file if exists, else fallback
          if os.path.exists('artwork.png'):
              image_url = f"{pages_url}artwork.png"
          elif os.path.exists('artwork.jpg'):
              image_url = f"{pages_url}artwork.jpg"
          else:
              image_url = "https://picsum.photos/1400/1400"

          # Fetch all releases with pagination
          releases = []
          page = 1
          while True:
              req = urllib.request.Request(f"https://api.github.com/repos/{repo}/releases?per_page=100&page={page}")
              req.add_header('Authorization', f'token {token}')
              try:
                  with urllib.request.urlopen(req) as r:
                      data = json.loads(r.read())
              except Exception as e:
                  print(f"Error fetching releases: {e}")
                  break
              if not data: break
              releases.extend(data)
              page += 1

          print(f"Found {len(releases)} releases")

          items = []
          for rel in releases:
              if rel.get('draft') or rel.get('prerelease'): continue
              dt = datetime.strptime(rel['published_at'], "%Y-%m-%dT%H:%M:%SZ")
              date = dt.strftime("%a, %d %b %Y %H:%M:%S GMT")
              body = rel.get('body', '')
              dur_match = re.search(r'METADATA::DURATION::(\d{2}:\d{2}:\d{2})', body)
              duration = dur_match.group(1) if dur_match else "00:00:00"

              for asset in rel.get('assets', []):
                  if asset['name'].endswith('.mp3'):
                      # Extract all metadata from release body
                      body = rel.get('body', '')

                      title_match = re.search(r'\*\*Title:\*\*\s*(.+?)(?:\n|$)', body)
                      host_match = re.search(r'\*\*Host:\*\*\s*(.+?)(?:\n|$)', body)
                      listeners_match = re.search(r'\*\*Listeners:\*\*\s*(.+?)(?:\n|$)', body)
                      recorded_match = re.search(r'\*\*Recorded:\*\*\s*(.+?)(?:\n|$)', body)
                      source_match = re.search(r'\*\*Source:\*\*\s*(.+?)(?:\n|$)', body)
                      spaceid_match = re.search(r'\*\*Space ID:\*\*\s*(.+?)(?:\n|$)', body)

                      # Get description (text after metadata block, before ---)
                      desc_match = re.search(r'\*\*Space ID:\*\*[^\n]*\n\n(.+?)\n\n---', body, re.DOTALL)

                      title = title_match.group(1).strip() if title_match else rel.get('name', 'Unknown')
                      host = host_match.group(1).strip() if host_match else 'Unknown'
                      listeners = listeners_match.group(1).strip() if listeners_match else '0'
                      recorded = recorded_match.group(1).strip() if recorded_match else ''
                      source = source_match.group(1).strip() if source_match else ''
                      space_id = spaceid_match.group(1).strip() if spaceid_match else ''
                      orig_desc = desc_match.group(1).strip() if desc_match else ''

                      # Build rich description
                      desc_parts = [escape(title)]
                      desc_parts.append(f"\n\nHost: {escape(host)}")
                      desc_parts.append(f"\nDuration: {duration}")
                      if listeners and listeners != '0':
                          desc_parts.append(f"\nOriginal Listeners: {escape(listeners)}")
                      if recorded:
                          desc_parts.append(f"\nRecorded: {escape(recorded)}")
                      if orig_desc:
                          desc_parts.append(f"\n\n{escape(orig_desc)}")
                      desc_parts.append("\n\n---")
                      if source:
                          desc_parts.append(f"\nSource: {escape(source)}")
                      if space_id:
                          desc_parts.append(f"\nSpace ID: {escape(space_id)}")

                      full_desc = ''.join(desc_parts)

                      # Generate tags for discovery
                      host_name = host.split('(')[0].strip() if '(' in host else host
                      tags = f"Twitter Space,X Space,{escape(host_name)},podcast,audio,live recording"

                      items.append(f'''<item>
            <title>{escape(rel['name'])}</title>
            <description>{full_desc}</description>
            <pubDate>{date}</pubDate>
            <enclosure url="{asset['browser_download_url']}" length="{asset['size']}" type="audio/mpeg"/>
            <guid isPermaLink="false">{asset['id']}</guid>
            <itunes:duration>{duration}</itunes:duration>
            <itunes:keywords>{tags}</itunes:keywords>
          </item>''')

          rss = f'''<?xml version="1.0" encoding="UTF-8"?>
          <rss version="2.0" xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd">
          <channel>
            <title>My Spaces Archive</title>
            <link>{pages_url}</link>
            <description>Archived Twitter Spaces</description>
            <language>en-us</language>
            <itunes:author>Logan Black</itunes:author>
            <itunes:owner>
              <itunes:name>Logan Black</itunes:name>
              <itunes:email>loganblack0@gmail.com</itunes:email>
            </itunes:owner>
            <itunes:image href="{image_url}"/>
            <image>
              <url>{image_url}</url>
              <title>My Spaces Archive</title>
              <link>{pages_url}</link>
            </image>
            <itunes:category text="Technology"/>
            <itunes:explicit>no</itunes:explicit>
            {''.join(items)}
          </channel>
          </rss>'''

          with open('podcast.xml', 'w') as f: f.write(rss)
          print(f"Generated RSS with {len(items)} episodes")
          PYEOF
          python3 gen_rss.py

      - name: Deploy to Pages
        run: |
          mkdir -p site
          cp podcast.xml site/
          [ -f artwork.png ] && cp artwork.png site/ || true
          [ -f artwork.jpg ] && cp artwork.jpg site/ || true

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy Pages
        uses: actions/deploy-pages@v4
