name: Start Batch Processing

on:
  push:
    paths:
      - 'batch_queue.txt'
  workflow_dispatch:
    inputs:
      max_concurrent:
        description: 'Max concurrent downloads (1-10)'
        required: false
        type: number
        default: 10

permissions:
  contents: read
  actions: write

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Initial Jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAX=${{ inputs.max_concurrent || 10 }}

          if [[ ! -f batch_queue.txt ]]; then
            echo "No batch_queue.txt found"
            exit 0
          fi

          # Count non-empty lines
          TOTAL=$(grep -c -v '^[[:space:]]*$' batch_queue.txt || echo "0")
          echo "Total URLs in queue: $TOTAL"

          if [[ "$TOTAL" -eq 0 ]]; then
            echo "Queue is empty"
            exit 0
          fi

          # Check how many are already running
          RUNNING=$(gh run list --workflow=batch_ingest.yml --status=in_progress -L 100 --json databaseId 2>/dev/null | jq 'length' || echo "0")
          echo "Currently running: $RUNNING"

          # Calculate how many to start
          SLOTS=$((MAX - RUNNING))
          if [[ "$SLOTS" -le 0 ]]; then
            echo "Already at max concurrent ($RUNNING running)"
            exit 0
          fi

          echo "Starting $SLOTS new jobs..."

          # Read first N URLs and trigger each
          head -n $SLOTS batch_queue.txt | grep -v '^[[:space:]]*$' | while read URL; do
            if [[ -n "$URL" ]]; then
              echo "Triggering: $URL"
              gh workflow run batch_ingest.yml -f url="$URL" || echo "Failed to trigger: $URL"
              sleep 2  # Avoid rate limits
            fi
          done

          echo "Done dispatching jobs"
